name: CI-2.0-Hardened

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Security & Test (Hardened)
    runs-on: ubuntu-22.04

    defaults:
      run:
        shell: bash --noprofile --norc -Eeuo pipefail {0}

    steps:
      - name: Assert runner OS
        run: |
          if [ "${RUNNER_OS}" != "Linux" ]; then
            echo "Unsupported OS: ${RUNNER_OS}"
            exit 1
          fi

      # --- Checkout (PINNED v4.1.1) ---
      - name: Checkout repository
        uses: actions/checkout@1e31de5234b9f8995739874a8ce0492dc87873e2

      # --- Secret Scan: Gitleaks ---
      # Используем официальный экшен Gitleaks
      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@1f2d10fb689bc07a5f56f48d6db61f5bbbe772fa

      # --- Python (PINNED v5.0.0) ---
      - name: Setup Python
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c
        with:
          python-version: "3.11"
          cache: pip

      # --- Pip upgrade (deterministic) ---
      - name: Upgrade pip
        run: python -m pip install --upgrade pip==24.0

      # --- Dependencies (locked + hashes) ---
      - name: Install dependencies
        run: |
          pip install --require-hashes -r requirements.txt

      # --- Install project (editable, no-deps) ---
      - name: Install project
        run: pip install --no-deps -e .

      # --- Security: Bandit ---
      - name: Security scan (bandit)
        run: bandit -r src -ll

      # --- Security: pip-audit (из установленных зависимостей) ---
      - name: Dependency audit
        run: pip-audit

      # --- Security: Trivy FS (FIXED SHA) ---
      - name: Trivy FS scan
        # Зафиксировал версию v0.20.0 через SHA
        uses: aquasecurity/trivy-action@6c175e9c4083a92bbca2f9724c8a5e33bc2d97a5
        with:
          scan-type: fs
          severity: CRITICAL,HIGH
          exit-code: 1

      # --- Tests ---
      - name: Run tests
        env:
          PYTHONHASHSEED: "0"
        run: pytest -q --disable-warnings --maxfail=1
